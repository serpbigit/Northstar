// This file contains all the client-side JavaScript logic

document.addEventListener('DOMContentLoaded', (event) => {
  loadSuggestedActions();
});

function showResponse(message, isError = false) {
  const outputArea = document.getElementById('output-area');
  // Use a simplified HTML rendering for bolding (**text**) if necessary
  let formattedMessage = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
  outputArea.innerHTML += `<div class="${isError ? 'error-message' : 'agent-message'}">${formattedMessage}</div>`;
  outputArea.scrollTop = outputArea.scrollHeight; // Scroll to bottom
}

function handleKeyPress(event) {
  if (event.key === 'Enter') {
    sendUserQuery();
  }
}

function runInitialSheetSetup() {
  showResponse('‚öôÔ∏è Running initial sheet setup...', false);
  google.script.run
    .withSuccessHandler(function(response) {
      showResponse(response);
      loadSuggestedActions(); // Reload suggestions as sheets are ready
    })
    .withFailureHandler(function(error) {
      showResponse(`‚ö†Ô∏è Error during setup: ${error.message}`, true);
    })
    .setupSheets();
}

function sendUserQuery(suggestion = null) {
  const inputElement = document.getElementById('user-input');
  const query = suggestion || inputElement.value;
  if (!query.trim()) return;

  showResponse(`üë§ You: ${query}`);
  inputElement.value = ''; // Clear input

  google.script.run
    .withSuccessHandler(function(response) {
      showResponse(`ü§ñ Polaris: ${response}`);
      // Simple logic: if the response indicates failure, reload suggestions for guidance
      if (response.startsWith('‚ö†Ô∏è')) {
          loadSuggestedActions();
      }
    })
    .withFailureHandler(function(error) {
      showResponse(`‚ö†Ô∏è Error: ${error.message}`, true);
      loadSuggestedActions();
    })
    .routeUserQuery(query);
}

function loadSuggestedActions() {
  const suggestionButtonsDiv = document.getElementById('suggestion-buttons');
  suggestionButtonsDiv.innerHTML = '<p class="loading-text">Loading...</p>';
  
  google.script.run
    .withSuccessHandler(function(result) {
      suggestionButtonsDiv.innerHTML = ''; // Clear loading
      
      if (result.ok && result.actions && result.actions.length > 0) {
        result.actions.forEach(action => {
          const button = document.createElement('button');
          button.textContent = `‚ö° ${action.key}`;
          button.title = action.description;
          button.onclick = () => sendUserQuery(action.key);
          suggestionButtonsDiv.appendChild(button);
        });
      } else {
        // If system is not set up, show setup message
        suggestionButtonsDiv.innerHTML = '<p class="error-text">System needs setup. Click "Run Initial Sheet Setup" first.</p>';
      }
    })
    .withFailureHandler(function(error) {
      suggestionButtonsDiv.innerHTML = '<p class="error-text">Failed to connect to server.</p>';
    })
    .getSuggestedActions();
}
